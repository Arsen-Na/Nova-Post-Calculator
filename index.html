<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Калькулятор ціни</title>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--muted:#666;--accent:#dbeefe}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      margin:16px;background:var(--bg);color:#111
    }
    .card{
      max-width:720px;margin:0 auto;padding:20px;background:var(--card);
      border-radius:10px;box-shadow:0 6px 24px rgba(20,20,30,0.06)
    }
    h1{margin:0 0 12px;font-size:20px}
    label{display:block;margin-top:12px;font-weight:600}
    input[type=number], .country-input{
      width:100%;box-sizing:border-box;padding:8px 10px;margin-top:6px;
      font-size:16px;border:1px solid #dcdde1;border-radius:8px;background:#fff;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>div{flex:1;min-width:120px;border:1.2px solid #e6e6e6;border-radius:8px;padding:10px}
    .result{margin-top:18px;padding:12px;background:#f0f8ff;border:1px solid var(--accent);border-radius:8px}
    .formula{font-family:monospace;background:#f4f4f6;padding:6px;border-radius:6px;display:inline-block}
    .muted{color:var(--muted);font-size:14px}
    .note{margin-top:8px;color:#444}

    /* v-select-like single autocompleter (Dokąd only) */
    .v-select {
      position: relative;
      display: block;
    }
    .vs__dropdown-toggle {
      display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #dcdde1;border-radius:8px;background:#fff;
      box-sizing:border-box;
    }
    .vs__selected-options { flex:1; display:flex; align-items:center; gap:8px; min-width:0; }
    .vs__search {
      flex:1; border:none; outline:none; background:transparent; font-size:16px; min-width:80px;
    }
    .vs__actions { display:flex; align-items:center; gap:8px; }
    .vs__clear { background:transparent;border:none; cursor:pointer; width:28px; height:28px; }
    .vs__open-indicator { width:16px; height:16px; opacity:0.7 }
    .vs__listbox {
      position:absolute; left:0; right:0; top:100%; z-index:80;
      margin-top:6px; border:1px solid #e0e0e0; background:#fff; border-radius:8px;
      max-height:240px; overflow:auto; box-shadow:0 8px 30px rgba(20,20,30,0.08);
      list-style:none; padding:6px 0; margin:0;
    }
    .vs__listbox li { padding:8px 12px; cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .vs__listbox li:hover, .vs__listbox li[aria-selected="true"] { background:#f5f7fa; }

    @media (max-width:600px){
      body{margin:8px}.card{padding:12px}h1{font-size:18px}
      input, .vs__search {font-size:14px}
    }
  </style>
</head>
<body>
  <main class="card" id="app">
    <h1>Калькулятор ціни</h1>
    <p class="muted">Введіть розміри в сантиметрах та фактичну вагу в кілограмах.</p>

    <div class="row">
      <div>
        <label for="length">Довжина (cm)</label>
        <input id="length" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="40">
      </div>
      <div>
        <label for="width">Ширина (cm)</label>
        <input id="width" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="30">
      </div>
      <div>
        <label for="height">Висота (cm)</label>
        <input id="height" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="20">
      </div>
    </div>

    <label for="weight">Фактична вага (kg)</label>
    <input id="weight" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="2.5">

    <!-- Інтегрований елемент: тільки "Dokąd" (отримувач), без "Skąd" і без прапорців -->
    <label for="vs2__combobox">Країна одержувача</label>
    <div id="selectRouteTo" class="v-select" aria-label="Change to">
      <div id="vs2__combobox" class="vs__dropdown-toggle" role="combobox" aria-haspopup="listbox"
           aria-expanded="false" aria-owns="vs2__listbox" aria-controls="vs2__listbox" aria-label="Search for option">
        <div class="vs__selected-options">
          <input id="vs2__search" class="vs__search" type="search" autocomplete="off" placeholder="Почніть вводити країну…" aria-autocomplete="list" />
        </div>
        <div class="vs__actions">
          <button id="vs2__clear" type="button" title="Clear Selected" aria-label="Clear Selected" class="vs__clear" style="display:none;">✕</button>
          <svg class="vs__open-indicator" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg" role="presentation">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M14.55 5.99L10.31 10.58L10.29 10.61C10.01 10.92 9.76 11.19 9.54 11.39C9.30 11.60 9.05 11.79 8.73 11.90C8.26 12.06 7.74 12.06 7.27 11.90C6.95 11.79 6.70 11.60 6.46 11.39C6.24 11.19 5.99 10.92 5.71 10.61L5.69 10.58L1.45 5.99L2.55 4.98L6.79 9.57C7.10 9.91 7.31 10.13 7.48 10.28C7.64 10.43 7.72 10.47 7.76 10.48C7.91 10.54 8.09 10.54 8.24 10.48C8.28 10.47 8.36 10.43 8.52 10.28C8.69 10.13 8.90 9.91 9.21 9.57L13.45 4.98L14.55 5.99Z" fill="black"/>
          </svg>
        </div>
      </div>

      <ul id="vs2__listbox" class="vs__listbox" role="listbox" aria-label="Вибір країни" hidden></ul>
    </div>

    <div class="result" aria-live="polite">
      <div class="note">Формула: <span class="formula">(<span id="f-l">довжина</span> × <span id="f-w">ширина</span> × <span id="f-h">висота</span>) ÷ 4000</span></div>
      <div style="margin-top:8px"><strong>Об'ємна вага:</strong> <span id="volumetric">—</span> <span class="muted">kg</span></div>
      <div style="margin-top:8px"><strong>Платна вага:</strong> <span id="billable">—</span> <span class="muted">kg</span></div>
      <div style="margin-top:8px"><strong>Ціна:</strong> <span id="price">—</span> <span class="muted">PLN</span></div>
    </div>
  </main>

  <script>
    // Елементи
    const lengthEl = document.getElementById('length'),
          widthEl = document.getElementById('width'),
          heightEl = document.getElementById('height'),
          weightEl = document.getElementById('weight'),
          volumetricEl = document.getElementById('volumetric'),
          billableEl = document.getElementById('billable'),
          priceEl = document.getElementById('price'),
          fL = document.getElementById('f-l'),
          fW = document.getElementById('f-w'),
          fH = document.getElementById('f-h');

    const searchInput = document.getElementById('vs2__search'),
          listbox = document.getElementById('vs2__listbox'),
          combobox = document.getElementById('vs2__combobox'),
          clearBtn = document.getElementById('vs2__clear');

    // Дані
    let countries = [], ratesMap = {}, aliasMap = {};
    const fallbackRate = {s:100, m:150, over10:300, perKg:8};

    // Параметри автокомплiту
    const MAX_RESULTS = 50;
    const DEBOUNCE_MS = 160;

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; }

    async function loadData(){
      try {
        const [rates, aliases] = await Promise.all([
          fetch('./rates.json').then(r => r.ok ? r.json() : Promise.reject('rates.json not found')),
          fetch('./rates_aliases.json').then(r => r.ok ? r.json() : Promise.reject('rates_aliases.json not found'))
        ]);
        countries = rates.map(r=>r.country);
        rates.forEach(r => ratesMap[r.country] = r);
        aliasMap = Object.keys(aliases).reduce((acc,k)=>{ acc[k.toLowerCase()] = aliases[k]; return acc; }, {});
        // pref fill: Polska if present
        const initial = ratesMap['Polska'] ? 'Polska' : (countries[0] || '');
        if (initial) searchInput.value = initial;
      } catch(err){
        console.error('Load error', err);
      } finally {
        compute();
      }
    }

    function normalize(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').trim(); }

    function searchCountries(q){
      if (!q) return [];
      const norm = normalize(q);
      const results = [];
      const seen = new Set();
      for (const c of countries){
        const lc = c.toLowerCase();
        if (lc.startsWith(norm) && !seen.has(lc)){ results.push(c); seen.add(lc); if (results.length>=MAX_RESULTS) return results; }
      }
      for (const c of countries){
        const lc = c.toLowerCase();
        if (!seen.has(lc) && lc.includes(norm)){ results.push(c); seen.add(lc); if (results.length>=MAX_RESULTS) return results; }
      }
      return results;
    }

    function renderList(items){
      listbox.innerHTML = '';
      if (!items || items.length === 0){ listbox.hidden = true; combobox.setAttribute('aria-expanded','false'); return; }
      const frag = document.createDocumentFragment();
      items.forEach((name, idx) => {
        const li = document.createElement('li');
        li.setAttribute('role','option');
        li.tabIndex = -1;
        li.textContent = name;
        li.dataset.index = idx;
        li.addEventListener('mousedown', e=> e.preventDefault()); // prevent blur before click
        li.addEventListener('click', ()=> {
          chooseCountry(name);
        });
        frag.appendChild(li);
      });
      listbox.appendChild(frag);
      listbox.hidden = false;
      combobox.setAttribute('aria-expanded','true');
    }

    function closeList(){
      listbox.innerHTML = '';
      listbox.hidden = true;
      combobox.setAttribute('aria-expanded','false');
    }

    function chooseCountry(name){
      searchInput.value = name;
      closeList();
      compute();
      clearBtn.style.display = 'inline-block';
    }

    function resolveCountry(input){
      if (!input) return '';
      const trimmed = input.trim();
      if (ratesMap[trimmed]) return trimmed;
      const exactKey = Object.keys(ratesMap).find(c => c.toLowerCase() === trimmed.toLowerCase());
      if (exactKey) return exactKey;
      const alias = aliasMap[trimmed.toLowerCase()];
      return alias && ratesMap[alias] ? alias : '';
    }

    // keyboard navigation
    function onKeyDown(e){
      const items = Array.from(listbox.querySelectorAll('li'));
      if (!items.length) return;
      const active = items.findIndex(it => it.getAttribute('aria-selected') === 'true');
      let idx = active;
      if (e.key === 'ArrowDown'){ e.preventDefault(); idx = Math.min(active + 1, items.length - 1); highlight(items, idx); }
      else if (e.key === 'ArrowUp'){ e.preventDefault(); idx = Math.max(active - 1, 0); highlight(items, idx); }
      else if (e.key === 'Enter'){ e.preventDefault(); const target = items[active] || items[0]; if (target) chooseCountry(target.textContent); }
      else if (e.key === 'Escape'){ closeList(); }
    }

    function highlight(items, idx){
      items.forEach(i=>i.removeAttribute('aria-selected'));
      if (items[idx]) { items[idx].setAttribute('aria-selected','true'); items[idx].scrollIntoView({block:'nearest'}); }
    }

    const onInputDebounced = debounce(()=>{
      const v = searchInput.value;
      // if exact match, close
      if (ratesMap[v] || Object.keys(ratesMap).find(c => c.toLowerCase() === v.toLowerCase())) { closeList(); return; }
      const results = searchCountries(v);
      renderList(results);
    }, DEBOUNCE_MS);

    // Bind events
    searchInput.addEventListener('input', onInputDebounced);
    searchInput.addEventListener('focus', onInputDebounced);
    searchInput.addEventListener('keydown', onKeyDown);

    clearBtn.addEventListener('click', ()=>{
      searchInput.value = '';
      clearBtn.style.display = 'none';
      searchInput.focus();
      closeList();
      compute();
    });

    document.addEventListener('click', (e)=>{
      if (!e.target.closest('#selectRouteTo')) closeList();
    });

    // Calculation logic
    function parseNumber(el){ const v = parseFloat(el.value); return Number.isFinite(v) ? v : 0; }
    function formatNumber(v){ return (Math.round(v*100)/100).toFixed(2); }

    function compute(){
      const L = parseNumber(lengthEl), W = parseNumber(widthEl), H = parseNumber(heightEl);
      const vol = (L*W*H)/4000;
      if (!L || !W || !H) { volumetricEl.textContent = billableEl.textContent = priceEl.textContent = '—'; return; }
      volumetricEl.textContent = formatNumber(vol);
      const actual = parseNumber(weightEl), billable = Math.max(vol, actual);
      billableEl.textContent = formatNumber(billable);

      const userInput = searchInput.value || '';
      const resolved = resolveCountry(userInput);
      const r = ratesMap[resolved] || fallbackRate;
      let price = 0;
      if (billable <= 2) price = r.s;
      else if (billable <= 10) price = r.m;
      else price = r.over10 + (Math.ceil(billable) - 10) * r.perKg;

      const priceText = formatNumber(price);
      priceEl.textContent = billable > 10 ? `${priceText} (10 кг = ${r.over10}, понад 10 кг = ${r.perKg})` : priceText;
    }

    function updateFormulaFields(){
      fL.textContent = lengthEl.value || 'довжина';
      fW.textContent = widthEl.value || 'ширина';
      fH.textContent = heightEl.value || 'висота';
    }

    [lengthEl, widthEl, heightEl, weightEl].forEach(el=>el.addEventListener('input', ()=>{ updateFormulaFields(); compute(); }));

    // init
    loadData();
  </script>
</body>
</html>
