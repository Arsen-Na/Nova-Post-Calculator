<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Калькулятор ціни</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;background:#f7f7f8;color:#111}
    .card{max-width:640px;margin:0 auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 6px 24px rgba(20,20,30,0.06)}
    h1{margin:0 0 12px;font-size:20px} label{display:block;margin-top:12px;font-weight:600}
    input[type=number], select, .country-input{width:100%;box-sizing:border-box;padding:8px 10px;margin-top:6px;font-size:16px;border:1px solid #dcdde1;border-radius:8px;background:#fff;height:56px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>div{flex:1;min-width:120px;border:1.5px solid #e0e0e0;border-radius:8px;padding:12px 10px 4px;box-shadow:0 2px 8px rgba(20,20,30,0.03);display:flex;flex-direction:column;justify-content:center;min-height:84px}
    .result{margin-top:18px;padding:12px;background:#f0f8ff;border:1px solid #dbeefe;border-radius:6px}
    .formula{font-family:monospace;background:#f4f4f6;padding:6px;border-radius:6px;display:inline-block}
    .muted{color:#666;font-size:14px}.note{margin-top:8px;color:#444}
    .autocomplete-wrapper{position:relative}
    .dropdown{position:absolute;left:0;right:0;margin-top:6px;border:1px solid #e0e0e0;background:#fff;border-radius:8px;max-height:240px;overflow:auto;box-shadow:0 8px 30px rgba(20,20,30,0.08);list-style:none;padding:6px 0;margin:0;z-index:1000}
    .dropdown li{padding:8px 12px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dropdown li:hover,.dropdown li[aria-selected="true"]{background:#f5f7fa}
    #countrySelect,label[for=countrySelect]{display:none}
    @media (max-width:768px){#countryInput,label[for=countryInput]{display:none}#countrySelect,label[for=countrySelect]{display:block}}
    @media (max-width:600px){body{margin:8px}.card{padding:12px}h1{font-size:18px}input,select{font-size:14px;height:48px}}
    .lang-row{display:flex;justify-content:flex-end}.lang-select{width:170px}
    .after-country{margin-top:6px}
    .customs{margin-top:12px;padding:12px;background:#fff7f0;border:1px solid #f2d9c4;border-radius:6px;color:#111}
    .warning{margin-top:12px;padding:12px;background:#ffecec;border:1px solid #f5c2c2;border-radius:6px;color:#611}
    .warning a{color:#522;text-decoration:underline}
    .mode-row{margin:6px 0 12px}
    .mode-block{display:flex;gap:12px;align-items:stretch}
    .mode-cell{flex:1;border:1.5px solid #e0e0e0;border-radius:8px;overflow:hidden;min-height:84px;display:flex}
    .mode-toggle{display:flex;width:100%}
    .mode-btn{flex:1;border:0;background:#fff;cursor:pointer;font-weight:700;display:flex;align-items:center;justify-content:center;font-size:16px;padding:0;height:100%;transition:background-color .18s ease,color .18s ease,box-shadow .18s ease}
    .mode-btn + .mode-btn{border-left:1px solid rgba(0,0,0,0.06)}
    .mode-btn:hover{background:rgba(0,0,0,0.04)}
    .mode-btn:active{transform:translateY(1px)}
    .mode-btn.active{background:#0b76ff;color:#fff;box-shadow:inset 0 -4px 12px rgba(0,0,0,0.06);filter:brightness(.95)}
    .mode-btn:focus{outline:3px solid rgba(11,118,255,0.14);outline-offset:-3px}
  </style>
</head>
<body>
<main class="card">
  <div class="lang-row">
    <label for="langSelect" id="label-lang" style="font-weight:600;margin-top:0;margin-right:8px;align-self:center">Мова</label>
    <select id="langSelect" class="lang-select" aria-label="Language selector">
      <option value="uk">Українська</option>
      <option value="en">English</option>
      <option value="pl">Polski</option>
    </select>
  </div>

  <h1 id="title">Калькулятор ціни</h1>
  <p class="muted" id="intro">Введіть розміри в сантиметрах та фактичну вагу в кілограмах.</p>

  <div class="mode-row" id="modeRow">
    <div class="mode-block" role="tablist" aria-label="Тип відправки">
      <div class="mode-cell">
        <div class="mode-toggle" id="modeToggleWrap">
          <button id="btnParcel" class="mode-btn" aria-pressed="true" role="tab">Посилка</button>
          <button id="btnDocs" class="mode-btn" aria-pressed="false" role="tab">Документи</button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="length" id="label-length">Довжина (cm)</label>
      <input id="length" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="40">
    </div>
    <div>
      <label for="width" id="label-width">Ширина (cm)</label>
      <input id="width" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="30">
    </div>
    <div>
      <label for="height" id="label-height">Висота (cm)</label>
      <input id="height" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="20">
    </div>
  </div>

  <label for="weight" id="label-weight">Фактична вага (kg)</label>
  <input id="weight" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="2.5">

  <label for="countryInput" id="label-country">Країна одержувача</label>
  <div class="autocomplete-wrapper">
    <input id="countryInput" class="country-input" type="search" autocomplete="off" placeholder="">
  </div>

  <label for="countrySelect" id="label-countrySelect" style="display:none">Країна одержувача</label>
  <select id="countrySelect" style="display:none"><option value="" disabled selected id="mobile-placeholder"></option></select>

  <div class="after-country">
    <label for="declaredValue" id="label-declared">Оціночна вартість</label>
    <input id="declaredValue" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="0">
  </div>

  <div class="result" aria-live="polite">
    <div class="note" id="formula-row">Формула: <span class="formula">(<span id="f-l">довжина</span> × <span id="f-w">ширина</span> × <span id="f-h">висота</span>) ÷ 4000</span></div>
    <div style="margin-top:8px"><strong id="label-volumetric">Об'ємна вага:</strong> <span id="volumetric">—</span> <span class="muted" id="unit-kg">kg</span></div>
    <div style="margin-top:8px"><strong id="label-billable">Платна вага:</strong> <span id="billable">—</span> <span class="muted" id="unit-kg-2">kg</span></div>
    <div style="margin-top:8px"><strong id="label-price">Ціна:</strong> <span id="price">—</span> <span class="muted" id="unit-currency">PLN</span></div>
  </div>

  <div id="customsBlock" class="customs" style="display:none" aria-live="polite">
    <strong id="customsText">Вартість митних платежів складе: —</strong>
    <div id="customsDetails" class="muted" style="margin-top:6px"></div>
  </div>

  <div id="presenceWarning" class="warning" style="display:none" aria-live="polite"></div>
</main>

<script>
const htmlEl=document.documentElement;
const el=id=>document.getElementById(id);
const langSelect=el('langSelect');
const lengthEl=el('length'), widthEl=el('width'), heightEl=el('height'), weightEl=el('weight');
const volumetricEl=el('volumetric'), billableEl=el('billable'), priceEl=el('price');
let fL=el('f-l'), fW=el('f-w'), fH=el('f-h');
const countryInput=el('countryInput'), countrySelect=el('countrySelect');
const declaredEl=el('declaredValue');
const customsBlock=el('customsBlock'), customsText=el('customsText'), customsDetails=el('customsDetails');
const presenceWarning=el('presenceWarning');
const unitKg=el('unit-kg'), unitKg2=el('unit-kg-2'), unitCurrency=el('unit-currency'), formulaRow=el('formula-row');
const btnParcel=el('btnParcel'), btnDocs=el('btnDocs');

const noticeLink='https://drive.google.com/file/d/1YHafkxkIv9wzWUNsmCvvVpN79mR9KZJe/view?usp=sharing';

const T={
 uk:{langLabel:'Мова',title:'Калькулятор ціни',intro:"Введіть розміри в сантиметрах та фактичну вагу в кілограмах.",length:'Довжина (cm)',width:'Ширина (cm)',height:'Висота (cm)',weight:'Фактична вага (kg)',country:"Країна одержувача",mobilePlaceholder:'Вибери країну',formulaWords:{l:'довжина',w:'ширина',h:'висота'},formulaLabel:'Формула',volumetric:"Об'ємна вага:",billable:"Платна вага:",price:"Ціна:",unitKg:'kg',currency:'PLN',declaredLabel:'Оціночна вартість',declaredPlaceholder:'0',per10:'за 10 КГ',perExtra:'за кожен наступний КГ',insuranceText:'0.5% "страхування" від ОВ',andSeparator:', ',customsTitle:'Вартість митних платежів складе:',customsDetailFmt:(eur,uah,pln)=>` ${eur} EUR або ${uah} UAH або ${pln} PLN`,presenceNotice:'Зверніть увагу, що доставка до даної країни відбувається партнером UPS авіа шляхом. Ознайомтесь із особливостями такої доставки у ',presenceLinkText:'1.1.3.21 СОК Перевірка відправлення на наявність забороненого вмісту з авіа-доставкою UPS',mode:{parcel:'Посилка',docs:'Документи'}},
 en:{langLabel:'Language',title:'Price calculator',intro:"Enter dimensions in centimetres and actual weight in kilograms.",length:'Length (cm)',width:'Width (cm)',height:'Height (cm)',weight:'Actual weight (kg)',country:"Destination country",mobilePlaceholder:'Choose country',formulaWords:{l:'length',w:'width',h:'height'},formulaLabel:'Formula',volumetric:"Volumetric weight:",billable:"Billable weight:",price:"Price:",unitKg:'kg',currency:'PLN',declaredLabel:'Estimated value',declaredPlaceholder:'0',per10:'for 10 KG',perExtra:'for each next KG',insuranceText:'0.5% "insurance" of EV',andSeparator:', ',customsTitle:'Customs payments will be:',customsDetailFmt:(eur,uah,pln)=>` ${eur} EUR or ${uah} UAH or ${pln} PLN`,presenceNotice:'Please note that delivery to this country is provided by UPS partner via air. See specifics in ',presenceLinkText:'1.1.3.21 SOK Shipment check for prohibited content with UPS air delivery',mode:{parcel:'Parcel',docs:'Documents'}},
 pl:{langLabel:'Język',title:'Kalkulator ceny',intro:"Wprowadź wymiary w centymetrach i rzeczywistą wagę w kilogramach.",length:'Długość (cm)',width:'Szerokość (cm)',height:'Wysokość (cm)',weight:'Rzeczywista waga (kg)',country:"Kraj odbiorcy",mobilePlaceholder:'Wybierz kraj',formulaWords:{l:'długość',w:'szerokość',h:'wysokość'},formulaLabel:'Formuła',volumetric:"Waga objętościowa:",billable:"Waga obciążalna:",price:"Cena:",unitKg:'kg',currency:'PLN',declaredLabel:'Wartość szacunkowa',declaredPlaceholder:'0',per10:'za 10 KG',perExtra:'za każdy kolejny KG',insuranceText:'0.5% "ubezpieczenie" od WS',andSeparator:', ',customsTitle:'Koszty opłat celnych wyniosą:',customsDetailFmt:(eur,uah,pln)=>` ${eur} EUR lub ${uah} UAH lub ${pln} PLN`,presenceNotice:'Zwróć uwagę, że dostawa do tego kraju odbywa się przez partnera UPS drogą lotniczą. Zapoznaj się ze szczegółami w ',presenceLinkText:'1.1.3.21 SOK Sprawdzenie przesyłki pod kątem zabronionej zawartości przy dostawie UPS (lotniczo)',mode:{parcel:'Paczka',docs:'Dokumenty'} }
};

let countries=[],ratesMap={},aliasMap={};
let presenceCountriesAllNames = [];
const fallbackRate={s:100,m:150,over10:300,perKg:8};

const debounce=(fn,ms=120)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
const parseNumber=el=>{const v=parseFloat(el.value);return Number.isFinite(v)?v:0;};
const formatNumber=v=>((Math.round(v*100)/100).toFixed(2));
const normalize=s=>String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim();

let FX={EUR_PLN:null,EUR_UAH:null,lastFetched:0},FX_TTL=1000*60*30;
async function fetchFxRates(){const now=Date.now();if(FX.lastFetched&&now-FX.lastFetched<FX_TTL&&FX.EUR_PLN&&FX.EUR_UAH)return FX;try{const res=await fetch('https://api.exchangerate.host/latest?base=EUR&symbols=PLN,UAH');if(!res.ok)throw 0;const data=await res.json();FX.EUR_PLN=data.rates.PLN;FX.EUR_UAH=data.rates.UAH;FX.lastFetched=Date.now();return FX}catch(e){FX.EUR_PLN=FX.EUR_PLN||4.3;FX.EUR_UAH=FX.EUR_UAH||40;FX.lastFetched=Date.now();return FX}}

function ratesFileForLang(lang){if(lang==='pl')return'./rates.json';if(lang==='uk')return'./rates-ua.json';if(lang==='en')return'./rates-eng.json';return'./rates.json';}

function applyTranslations(lang){
  const t=T[lang]||T.uk;
  htmlEl.lang=lang;
  el('label-lang').textContent=t.langLabel;
  el('title').textContent=t.title;
  el('intro').textContent=t.intro;
  el('label-length').textContent=t.length;
  el('label-width').textContent=t.width;
  el('label-height').textContent=t.height;
  el('label-weight').textContent=t.weight;
  el('label-country').textContent=t.country;
  el('label-countrySelect').textContent=t.country;
  el('label-volumetric').textContent=t.volumetric;
  el('label-billable').textContent=t.billable;
  el('label-price').textContent=t.price;
  unitKg.textContent=t.unitKg; unitKg2.textContent=t.unitKg; unitCurrency.textContent=t.currency;
  countryInput.placeholder = t.mobilePlaceholder;
  const mobilePh = el('mobile-placeholder'); if(mobilePh) mobilePh.textContent = t.mobilePlaceholder;
  fL.textContent=t.formulaWords.l; fW.textContent=t.formulaWords.w; fH.textContent=t.formulaWords.h;
  el('label-declared').textContent=t.declaredLabel; declaredEl.placeholder=t.declaredPlaceholder;
  btnParcel.textContent=t.mode.parcel; btnDocs.textContent=t.mode.docs;
  formulaRow.innerHTML=`${t.formulaLabel}: <span class="formula">(<span id="f-l">${t.formulaWords.l}</span> × <span id="f-w">${t.formulaWords.w}</span> × <span id="f-h">${t.formulaWords.h}</span>) ÷ 4000</span>`;
  fL=document.getElementById('f-l'); fW=document.getElementById('f-w'); fH=document.getElementById('f-h');
  updateModeButtonVisuals();
}

async function loadPresenceCountries(){
  try{
    const res = await fetch('./presence_countries.json');
    if(!res.ok) throw 0;
    const data = await res.json();
    presenceCountriesAllNames = data.map(item => [
      String(item.uk||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''),
      String(item.pl||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''),
      String(item.en||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    ]);
  }catch(e){
    const fallback=[
      ['україна','ukraina','ukraine'],['молдова','mołdawa','moldova'],['польща','polska','poland'],['литва','litwa','lithuania'],
      ['чехія','czechy','czechia'],['румунія','rumunia','romania'],['німеччина','niemcy','germany'],['словаччина','słowacja','slovakia'],
      ['естонія','estonia','estonia'],['латвія','łotwa','latvia'],['угорщина','węgry','hungary'],['італія','włochy','italy'],
      ['велика британія','wielka brytania','united kingdom'],['іспанія','hiszpania','spain'],['франція','francja','france'],['австрія','austria','austria'],['нідерланди','holandia','netherlands']
    ];
    presenceCountriesAllNames = fallback;
  }
}

async function loadRatesForLang(lang){
  const file=ratesFileForLang(lang);
  countries=[];ratesMap={};aliasMap={};
  try{
    const res=await fetch(file);if(!res.ok)throw 0;
    const data=await res.json();
    data.forEach(item=>{const name=item.country;countries.push(name);ratesMap[name]=item;});
    try{const aRes=await fetch(file.replace('.json','_aliases.json'));if(aRes.ok){const aData=await aRes.json();Object.keys(aData).forEach(k=>aliasMap[k.toLowerCase()]=aData[k]);}}catch(e){}
    populateCountrySelects();
    countryInput.value=''; countrySelect.value='';
  }catch(e){countrySelect.innerHTML='<option value="" disabled selected>Not available</option>';countries=[];ratesMap={};}
  finally{compute();}
}

function populateCountrySelects(){countrySelect.innerHTML='';const frag=document.createDocumentFragment();countries.forEach(name=>{const o=document.createElement('option');o.value=name;o.textContent=name;frag.appendChild(o);});countrySelect.appendChild(frag);}

function resolveCountry(input){
  if(!input) return '';
  if(ratesMap[input]) return input;
  const found = Object.keys(ratesMap).find(c=>c.toLowerCase()===input.toLowerCase());
  if(found) return found;
  const alias = aliasMap[String(input).toLowerCase()];
  if(alias && ratesMap[alias]) return alias;
  return '';
}

function syncCountryToSelect(){ const r = resolveCountry(countryInput.value); if(r) countrySelect.value = r; }
function syncSelectToInput(){ if(countrySelect.value) countryInput.value = countrySelect.value; }

let sendMode='parcel';

function updateModeButtonVisuals(){
  const activeClass='active';
  if(btnParcel && btnDocs){
    if(sendMode==='docs'){
      btnDocs.classList.add(activeClass); btnDocs.setAttribute('aria-pressed','true');
      btnParcel.classList.remove(activeClass); btnParcel.setAttribute('aria-pressed','false');
    } else {
      btnParcel.classList.add(activeClass); btnParcel.setAttribute('aria-pressed','true');
      btnDocs.classList.remove(activeClass); btnDocs.setAttribute('aria-pressed','false');
    }
  }
}

function setMode(mode){
  sendMode=mode;
  const docsFixed={length:35,width:25,height:2,weight:1};
  if(mode==='docs'){
    lengthEl.value=docsFixed.length; widthEl.value=docsFixed.width; heightEl.value=docsFixed.height; weightEl.value=docsFixed.weight;
    [lengthEl,widthEl,heightEl,weightEl].forEach(i=>{i.readOnly=true;i.tabIndex=-1;i.setAttribute('aria-disabled','true');});
  }else{
    [lengthEl,widthEl,heightEl,weightEl].forEach(i=>{i.readOnly=false;i.removeAttribute('tabIndex');i.removeAttribute('aria-disabled');});
    lengthEl.value=''; widthEl.value=''; heightEl.value=''; weightEl.value='';
  }
  updateModeButtonVisuals();
  compute();
}

async function compute(){
  const t=T[htmlEl.lang]||T.uk;
  const L=parseNumber(lengthEl), W=parseNumber(widthEl), H=parseNumber(heightEl);
  if(!L||!W||!H){volumetricEl.textContent=billableEl.textContent=priceEl.textContent='—'; hideCustoms(); hideWarning(); return;}
  const vol=(L*W*H)/4000; volumetricEl.textContent=formatNumber(vol);
  const actual=parseNumber(weightEl), billable=Math.max(vol,actual); billableEl.textContent=formatNumber(billable);
  const userInput = countryInput.value || countrySelect.value || '';
  const r = ratesMap[ resolveCountry(userInput) ] || fallbackRate;
  let basePrice, priceFor10kg=null, perExtraKg=null;
  if(sendMode==='docs' && r && typeof r.docs!=='undefined'){ basePrice = Number(r.docs); }
  else {
    if(billable<=2) basePrice = r.s;
    else if(billable<=10) basePrice = r.m;
    else { priceFor10kg = r.over10; perExtraKg = r.perKg; basePrice = r.over10 + (Math.ceil(billable)-10)*r.perKg; }
  }
  const declared=parseNumber(declaredEl);
  let surcharge=0, surchargeShown=0; if(declared>=1000){surcharge=declared*0.005; surchargeShown=surcharge;}
  const total = basePrice + surcharge;
  const parts=[];
  if(billable>10){ if(priceFor10kg==null) priceFor10kg = r.over10; parts.push(`${priceFor10kg} ${t.per10}`); parts.push(`${perExtraKg} ${t.perExtra}`); }
  if(surchargeShown>0) parts.push(`${formatNumber(surchargeShown)} ${t.insuranceText}`);
  const inside = parts.length ? ` (${parts.join(t.andSeparator)})` : '';
  priceEl.textContent = `${formatNumber(total)} PLN${inside}`;

  const destResolved = resolveCountry(userInput);
  const isUkraine = destResolved && /Україн|Ukraine|Ukraina/i.test(destResolved);
  if(isUkraine && declared>0){
    const fx = await fetchFxRates();
    const eurPerPln = 1 / fx.EUR_PLN;
    const declaredEUR = declared * eurPerPln;
    if(declaredEUR >= 150){
      const excess = declaredEUR - 150;
      const duty = excess * 0.10;
      const vat = (excess + duty) * 0.20;
      const customsTotalEUR = duty + vat;
      const customsPLN = customsTotalEUR * fx.EUR_PLN;
      const customsUAH = customsTotalEUR * fx.EUR_UAH;
      const X_eur = formatNumber(customsTotalEUR), X_uah = formatNumber(customsUAH), X_pln = formatNumber(customsPLN);
      customsText.textContent = t.customsTitle;
      customsDetails.textContent = t.customsDetailFmt(X_eur, X_uah, X_pln);
      customsBlock.style.display = 'block';
    } else hideCustoms();
  } else hideCustoms();

  const destNorm = normalize(destResolved);
  const inPresence = destResolved && presenceCountriesAllNames.some(arr => arr.includes(destNorm));
  if(destResolved && !inPresence) showWarning(t); else hideWarning();
}

function hideCustoms(){ customsBlock.style.display='none'; customsText.textContent=''; customsDetails.textContent=''; }
function showWarning(t){ presenceWarning.style.display='block'; presenceWarning.innerHTML = `${t.presenceNotice}<a href="${noticeLink}" target="_blank" rel="noopener noreferrer">${t.presenceLinkText}</a>`; }
function hideWarning(){ presenceWarning.style.display='none'; presenceWarning.innerHTML=''; }

[lengthEl,widthEl,heightEl,weightEl,declaredEl].forEach(i=>i.addEventListener('input',debounce(()=>{const t=T[htmlEl.lang]||T.uk; if(fL) fL.textContent = lengthEl.value || t.formulaWords.l; if(fW) fW.textContent = widthEl.value || t.formulaWords.w; if(fH) fH.textContent = heightEl.value || t.formulaWords.h; compute();},120)));
countryInput.addEventListener('input',debounce(()=>{syncCountryToSelect();compute();},120));
countryInput.addEventListener('change',()=>{syncCountryToSelect();compute();});
countrySelect.addEventListener('change',()=>{syncSelectToInput();compute();});

(function desktopDropdown(){
  const isMobile=/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent); if(isMobile) return;
  const wrapper=countryInput.parentElement; wrapper.style.position=wrapper.style.position||'relative';
  const dropdown=document.createElement('ul'); dropdown.className='dropdown'; dropdown.hidden=true; wrapper.appendChild(dropdown);
  let items=[], highlighted=-1, MAX_SHOW=200;
  const render=arr=>{ dropdown.innerHTML=''; if(!arr||!arr.length){ dropdown.hidden=true; return; } const frag=document.createDocumentFragment(); arr.forEach((name,i)=>{ const li=document.createElement('li'); li.textContent=name; li.dataset.index=i; li.addEventListener('mousedown',e=>e.preventDefault()); li.addEventListener('click',()=>{ countryInput.value=name; dropdown.hidden=true; syncCountryToSelect(); compute(); }); frag.appendChild(li); }); dropdown.appendChild(frag); dropdown.hidden=false; highlighted=-1; };
  const showMatches=q=>{ const qn = normalize(q===undefined?countryInput.value:q); let res=[]; if(!qn) res = countries.slice(0,MAX_SHOW); else { const seen=new Set(); for(const c of countries){ const lc=c.toLowerCase(); if(lc.startsWith(qn) && !seen.has(lc)){ res.push(c); seen.add(lc); if(res.length>=MAX_SHOW) break; } } if(res.length<MAX_SHOW) for(const c of countries){ const lc=c.toLowerCase(); if(!seen.has(lc) && lc.includes(qn)){ res.push(c); seen.add(lc); if(res.length>=MAX_SHOW) break; } } } items=res; render(res); };
  const debouncedShow=debounce(showMatches,120);
  countryInput.addEventListener('focus',()=>showMatches());
  countryInput.addEventListener('click',e=>{ e.stopPropagation(); showMatches(); });
  countryInput.addEventListener('input',()=>debouncedShow(countryInput.value));
  countryInput.addEventListener('keydown',e=>{ if(dropdown.hidden) return; const lis=dropdown.querySelectorAll('li'); if(!lis.length) return; if(e.key==='ArrowDown'){ e.preventDefault(); highlighted = Math.min(highlighted+1, lis.length-1); updateHighlight(lis); } else if(e.key==='ArrowUp'){ e.preventDefault(); highlighted = Math.max(highlighted-1, 0); updateHighlight(lis); } else if(e.key==='Enter'){ e.preventDefault(); const sel = lis[highlighted] || lis[0]; if(sel){ countryInput.value = sel.textContent; dropdown.hidden = true; syncCountryToSelect(); compute(); } } else if(e.key==='Escape'){ dropdown.hidden = true; highlighted = -1; } });
  function updateHighlight(lis){ lis.forEach(li=>li.removeAttribute('aria-selected')); if(highlighted>=0 && lis[highlighted]){ lis[highlighted].setAttribute('aria-selected','true'); lis[highlighted].scrollIntoView({block:'nearest'}); } }
  document.addEventListener('click',e=>{ if(!e.target.closest(wrapper)) dropdown.hidden=true; });
  window.addEventListener('resize',()=>{ if(!dropdown.hidden) showMatches(); });
})();

btnParcel.addEventListener('click',()=>setMode('parcel'));
btnDocs.addEventListener('click',()=>setMode('docs'));

langSelect.addEventListener('change',async(e)=>{ const lang=e.target.value; applyTranslations(lang); await loadRatesForLang(lang); });

document.addEventListener('DOMContentLoaded',async()=>{ const defaultLang = langSelect.value || 'uk'; applyTranslations(defaultLang); if(window.matchMedia && window.matchMedia('(max-width:768px)').matches){ countryInput.style.display='none'; el('label-country').style.display='none'; countrySelect.style.display='block'; el('label-countrySelect').style.display='block'; } else { countrySelect.style.display='none'; el('label-countrySelect').style.display='none'; } await loadRatesForLang(defaultLang); await loadPresenceCountries(); setMode('parcel'); });
</script>
</body>
</html>
