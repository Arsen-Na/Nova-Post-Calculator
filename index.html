<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Калькулятор ціни</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;background:#f7f7f8;color:#111}
    .card{max-width:640px;margin:0 auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 6px 24px rgba(20,20,30,0.06)}
    h1{margin:0 0 12px;font-size:20px} label{display:block;margin-top:12px;font-weight:600}
    input[type=number], select, .country-input {width:100%;box-sizing:border-box;padding:8px 10px;margin-top:6px;font-size:16px;border:1px solid #dcdde1;border-radius:6px;background:#fff}
    .row{display:flex;gap:12px;flex-wrap:wrap} .row>div{flex:1;min-width:120px;border:1.5px solid #e0e0e0;border-radius:8px;padding:12px 10px 4px;box-shadow:0 2px 8px rgba(20,20,30,0.03)}
    .result{margin-top:18px;padding:12px;background:#f0f8ff;border:1px solid #dbeefe;border-radius:6px}
    .formula{font-family:monospace;background:#f4f4f6;padding:6px;border-radius:6px;display:inline-block}
    .muted{color:#666;font-size:14px} .note{margin-top:8px;color:#444}
    /* desktop dropdown styles */
    .autocomplete-wrapper{position:relative}
    .dropdown{position:absolute;left:0;right:0;margin-top:6px;border:1px solid #e0e0e0;background:#fff;border-radius:8px;max-height:240px;overflow:auto;box-shadow:0 8px 30px rgba(20,20,30,0.08);list-style:none;padding:6px 0;margin:0;z-index:1000}
    .dropdown li{padding:8px 12px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dropdown li:hover, .dropdown li[aria-selected="true"]{background:#f5f7fa}
    /* show select on small screens */
    #countrySelect, label[for=countrySelect]{display:none}
    @media (max-width:768px){
      #countryInput, label[for=countryInput]{display:none}
      #countrySelect, label[for=countrySelect]{display:block}
    }
    @media (max-width:600px){
      body{margin:8px}.card{padding:12px}h1{font-size:18px}input,select{font-size:14px}
    }
    .lang-row{display:flex;justify-content:flex-end}
    .lang-select{width:170px}
  </style>
</head>
<body>
<main class="card">
  <div class="lang-row">
    <label for="langSelect" style="font-weight:600;margin-top:0;margin-right:8px;align-self:center" id="label-lang">Мова</label>
    <select id="langSelect" class="lang-select" aria-label="Language selector">
      <option value="uk">Українська</option>
      <option value="en">English</option>
      <option value="pl">Polski</option>
    </select>
  </div>

  <h1 id="title">Калькулятор ціни</h1>

  <p class="muted" id="intro">Введіть розміри в сантиметрах та фактичну вагу в кілограмах.</p>

  <div class="row">
    <div>
      <label for="length" id="label-length">Довжина (cm)</label>
      <input id="length" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="40">
    </div>
    <div>
      <label for="width" id="label-width">Ширина (cm)</label>
      <input id="width" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="30">
    </div>
    <div>
      <label for="height" id="label-height">Висота (cm)</label>
      <input id="height" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="20">
    </div>
  </div>

  <label for="weight" id="label-weight">Фактична вага (kg)</label>
  <input id="weight" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="2.5">

  <!-- Desktop: custom input with dropdown (no datalist) -->
  <label for="countryInput" id="label-country">Країна одержувача</label>
  <div class="autocomplete-wrapper">
    <input id="countryInput" class="country-input" type="search" autocomplete="off" placeholder="Polska">
    <!-- dropdown is injected by script for desktop -->
  </div>

  <!-- Mobile: select (visible on mobile) -->
  <label for="countrySelect" id="label-countrySelect" style="display:none">Країна одержувача</label>
  <select id="countrySelect" style="display:none">
    <option value="" disabled selected id="mobile-placeholder">Завантаження…</option>
  </select>

  <div class="result" aria-live="polite">
    <div class="note">Формула: <span class="formula">(<span id="f-l">довжина</span> × <span id="f-w">ширина</span> × <span id="f-h">висота</span>) ÷ 4000</span></div>

    <div style="margin-top:8px"><strong id="label-volumetric">Об'ємна вага:</strong> <span id="volumetric">—</span> <span class="muted" id="unit-kg">kg</span></div>
    <div style="margin-top:8px"><strong id="label-billable">Платна вага:</strong> <span id="billable">—</span> <span class="muted" id="unit-kg-2">kg</span></div>
    <div style="margin-top:8px"><strong id="label-price">Ціна:</strong> <span id="price">—</span> <span class="muted" id="unit-currency">PLN</span></div>
  </div>
</main>

<script>
/* Elements */
const htmlEl = document.documentElement;
const langSelect = document.getElementById('langSelect');
const titleEl = document.getElementById('title');
const introEl = document.getElementById('intro');

const lengthEl = document.getElementById('length'),
      widthEl = document.getElementById('width'),
      heightEl = document.getElementById('height'),
      weightEl = document.getElementById('weight'),
      volumetricEl = document.getElementById('volumetric'),
      billableEl = document.getElementById('billable'),
      priceEl = document.getElementById('price'),
      fL = document.getElementById('f-l'),
      fW = document.getElementById('f-w'),
      fH = document.getElementById('f-h');

const countryInput = document.getElementById('countryInput'),
      countrySelect = document.getElementById('countrySelect'),
      mobilePlaceholder = document.getElementById('mobile-placeholder');

const labelLang = document.getElementById('label-lang');
const labelLength = document.getElementById('label-length');
const labelWidth = document.getElementById('label-width');
const labelHeight = document.getElementById('label-height');
const labelWeight = document.getElementById('label-weight');
const labelCountry = document.getElementById('label-country');
const labelCountrySelect = document.getElementById('label-countrySelect');
const labelVolumetric = document.getElementById('label-volumetric');
const labelBillable = document.getElementById('label-billable');
const labelPrice = document.getElementById('label-price');
const unitKg = document.getElementById('unit-kg');
const unitKg2 = document.getElementById('unit-kg-2');
const unitCurrency = document.getElementById('unit-currency');
const fPlaceholders = { length: 'довжина', width: 'ширина', height: 'висота' };

/* Simple translations */
const T = {
  uk: {
    langLabel: 'Мова',
    title: 'Калькулятор ціни',
    intro: "Введіть розміри в сантиметрах та фактичну вагу в кілограмах.",
    length: 'Довжина (cm)',
    width: 'Ширина (cm)',
    height: 'Висота (cm)',
    weight: 'Фактична вага (kg)',
    country: "Країна одержувача",
    mobilePlaceholder: 'Завантаження…',
    formula: { l: 'довжина', w: 'ширина', h: 'висота' },
    volumetric: "Об'ємна вага:",
    billable: "Платна вага:",
    price: "Ціна:",
    unitKg: 'kg',
    currency: 'PLN',
    countryInputPlaceholder: 'Polska',
    volumeFormulaLabel: "Формула: "
  },
  en: {
    langLabel: 'Language',
    title: 'Price calculator',
    intro: "Enter dimensions in centimetres and actual weight in kilograms.",
    length: 'Length (cm)',
    width: 'Width (cm)',
    height: 'Height (cm)',
    weight: 'Actual weight (kg)',
    country: "Destination country",
    mobilePlaceholder: 'Loading…',
    formula: { l: 'length', w: 'width', h: 'height' },
    volumetric: "Volumetric weight:",
    billable: "Billable weight:",
    price: "Price:",
    unitKg: 'kg',
    currency: 'PLN',
    countryInputPlaceholder: 'Poland',
    volumeFormulaLabel: "Formula: "
  },
  pl: {
    langLabel: 'Język',
    title: 'Kalkulator ceny',
    intro: "Wprowadź wymiary w centymetrach i rzeczywistą wagę w kilogramach.",
    length: 'Długość (cm)',
    width: 'Szerokość (cm)',
    height: 'Wysokość (cm)',
    weight: 'Rzeczywista waga (kg)',
    country: "Kraj odbiorcy",
    mobilePlaceholder: 'Ładowanie…',
    formula: { l: 'długość', w: 'szerokość', h: 'wysokość' },
    volumetric: "Waga objętościowa:",
    billable: "Waga obciążalna:",
    price: "Cena:",
    unitKg: 'kg',
    currency: 'PLN',
    countryInputPlaceholder: 'Polska',
    volumeFormulaLabel: "Formuła: "
  }
};

/* --- language switcher logic --- */
function applyTranslations(lang) {
  const t = T[lang] || T.uk;
  // set page language attribute
  htmlEl.lang = lang;

  // static texts
  labelLang.textContent = t.langLabel;
  titleEl.textContent = t.title;
  introEl.textContent = t.intro;

  labelLength.textContent = t.length;
  labelWidth.textContent = t.width;
  labelHeight.textContent = t.height;
  labelWeight.textContent = t.weight;
  labelCountry.textContent = t.country;
  labelCountrySelect.textContent = t.country;
  mobilePlaceholder.textContent = t.mobilePlaceholder;

  labelVolumetric.textContent = t.volumetric;
  labelBillable.textContent = t.billable;
  labelPrice.textContent = t.price;

  unitKg.textContent = t.unitKg;
  unitKg2.textContent = t.unitKg;
  unitCurrency.textContent = t.currency;

  // placeholders
  countryInput.placeholder = t.countryInputPlaceholder;
  lengthEl.placeholder = lengthEl.placeholder || '40';
  widthEl.placeholder = widthEl.placeholder || '30';
  heightEl.placeholder = heightEl.placeholder || '20';
  weightEl.placeholder = weightEl.placeholder || '2.5';

  // formula words
  fL.textContent = t.formula.l;
  fW.textContent = t.formula.w;
  fH.textContent = t.formula.h;
}

/* initialize default language */
applyTranslations('uk');

/* handle user selection */
langSelect.addEventListener('change', e => {
  applyTranslations(e.target.value);
});

/* --- rest of calculator: data loading, dropdown, compute --- */

/* Data and rate loading (kept minimal / same logic assumption) */
let countries = [], ratesMap = {}, aliasMap = {};
const fallbackRate = {s:100, m:150, over10:300, perKg:8};
const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);

const debounce = (fn, ms=120)=>{ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; };
const parseNumber = el => { const v = parseFloat(el.value); return Number.isFinite(v) ? v : 0; };
const formatNumber = v => (Math.round(v*100)/100).toFixed(2);
const normalize = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();

/* Load rates.json and rates_aliases.json if present, otherwise fallback */
async function loadData(){
  try {
    const [rRes,aRes] = await Promise.all([
      fetch('./rates.json').then(x=>x.ok?x.json():Promise.reject('rates.json')),
      fetch('./rates_aliases.json').then(x=>x.ok?x.json():Promise.reject('rates_aliases.json'))
    ]);
    countries = rRes.map(i=>i.country);
    rRes.forEach(i=>ratesMap[i.country]=i);
    aliasMap = Object.keys(aRes||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = aRes[k]; return acc; },{});

    // populate mobile select
    const fragS = document.createDocumentFragment();
    countries.forEach(name=>{ const s = document.createElement('option'); s.value = name; s.textContent = name; fragS.appendChild(s); });
    countrySelect.innerHTML = '';
    countrySelect.appendChild(fragS);

    const initial = ratesMap['Polska'] ? 'Polska' : (countries[0]||'');
    if (initial){ countryInput.value = initial; countrySelect.value = initial; }
  } catch(err){
    console.warn('Rates load failed, using fallback', err);
    countrySelect.innerHTML = '<option value="" disabled selected>Not available</option>';
  } finally {
    compute();
  }
}

/* Resolve canonical name */
function resolveCountry(input){
  if (!input) return '';
  if (ratesMap[input]) return input;
  const exact = Object.keys(ratesMap).find(c=>c.toLowerCase()===input.toLowerCase());
  if (exact) return exact;
  const alias = aliasMap[input.toLowerCase()];
  return alias && ratesMap[alias] ? alias : '';
}

/* sync functions */
function syncCountryToSelect(){ const resolved = resolveCountry(countryInput.value); if (resolved && countrySelect.value !== resolved) countrySelect.value = resolved; }
function syncSelectToInput(){ if (countrySelect.value && countryInput.value !== countrySelect.value) countryInput.value = countrySelect.value; }

/* Compute price */
function compute(){
  const L = parseNumber(lengthEl), W = parseNumber(widthEl), H = parseNumber(heightEl);
  const vol = (L*W*H)/4000;
  if (!L || !W || !H){ volumetricEl.textContent = billableEl.textContent = priceEl.textContent = '—'; return; }
  volumetricEl.textContent = formatNumber(vol);
  const actual = parseNumber(weightEl), billable = Math.max(vol, actual);
  billableEl.textContent = formatNumber(billable);
  const userInput = countryInput.value || countrySelect.value || '';
  const r = ratesMap[resolveCountry(userInput)] || fallbackRate;
  let price = billable <= 2 ? r.s : billable <= 10 ? r.m : r.over10 + (Math.ceil(billable)-10)*r.perKg;
  priceEl.textContent = billable > 10 ? `${formatNumber(price)} (10 kg = ${r.over10}, ponad 10 kg = ${r.perKg})` : formatNumber(price);
}

/* Wire events */
[lengthEl,widthEl,heightEl,weightEl].forEach(el=>el.addEventListener('input', ()=>{
  fL.textContent = lengthEl.value || T[htmlEl.lang].formula.l;
  fW.textContent = widthEl.value || T[htmlEl.lang].formula.w;
  fH.textContent = heightEl.value || T[htmlEl.lang].formula.h;
  compute();
}));

countryInput.addEventListener('input', ()=>{ syncCountryToSelect(); compute(); });
countryInput.addEventListener('change', ()=>{ syncCountryToSelect(); compute(); });
countrySelect.addEventListener('change', ()=>{ syncSelectToInput(); compute(); });

/* Desktop-only dropdown (replaces datalist behavior) */
(function desktopDropdown(){
  if (isMobile) return;
  const wrapper = countryInput.parentElement;
  wrapper.style.position = wrapper.style.position || 'relative';
  const dropdown = document.createElement('ul');
  dropdown.className = 'dropdown';
  dropdown.hidden = true;
  wrapper.appendChild(dropdown);
  let items = [], highlighted = -1, MAX_SHOW = 200;

  const render = arr => {
    dropdown.innerHTML = '';
    if (!arr || !arr.length){ dropdown.hidden = true; return; }
    const frag = document.createDocumentFragment();
    arr.forEach((name,i)=>{
      const li = document.createElement('li');
      li.textContent = name;
      li.dataset.index = i;
      li.addEventListener('mousedown', e=>e.preventDefault());
      li.addEventListener('click', ()=> choose(name));
      frag.appendChild(li);
    });
    dropdown.appendChild(frag);
    dropdown.hidden = false;
    highlighted = -1;
  };
  const choose = name => { countryInput.value = name; dropdown.hidden = true; syncCountryToSelect(); compute(); };
  const showMatches = q => {
    const qn = normalize(q === undefined ? countryInput.value : q);
    let res = [];
    if (!qn) res = countries.slice(0, MAX_SHOW);
    else {
      const seen = new Set();
      for (const c of countries){
        const lc = c.toLowerCase();
        if (lc.startsWith(qn) && !seen.has(lc)){ res.push(c); seen.add(lc); if (res.length>=MAX_SHOW) break; }
      }
      if (res.length < MAX_SHOW) for (const c of countries){
        const lc = c.toLowerCase();
        if (!seen.has(lc) && lc.includes(qn)){ res.push(c); seen.add(lc); if (res.length>=MAX_SHOW) break; }
      }
    }
    items = res; render(res);
  };
  const debouncedShow = debounce(showMatches, 120);
  countryInput.addEventListener('focus', ()=> showMatches());
  countryInput.addEventListener('click', e=>{ e.stopPropagation(); showMatches(); });
  countryInput.addEventListener('input', ()=> debouncedShow(countryInput.value));
  countryInput.addEventListener('keydown', e=>{
    if (dropdown.hidden) return;
    const lis = dropdown.querySelectorAll('li');
    if (!lis.length) return;
    if (e.key === 'ArrowDown'){ e.preventDefault(); highlighted = Math.min(highlighted+1, lis.length-1); updateHighlight(lis);
    } else if (e.key === 'ArrowUp'){ e.preventDefault(); highlighted = Math.max(highlighted-1, 0); updateHighlight(lis);
    } else if (e.key === 'Enter'){ e.preventDefault(); const sel = lis[highlighted] || lis[0]; if (sel) choose(sel.textContent);
    } else if (e.key === 'Escape'){ dropdown.hidden = true; highlighted = -1; }
  });
  function updateHighlight(lis){ lis.forEach(li=>li.removeAttribute('aria-selected')); if (highlighted >= 0 && lis[highlighted]) { lis[highlighted].setAttribute('aria-selected','true'); lis[highlighted].scrollIntoView({block:'nearest'}); } }
  document.addEventListener('click', e=>{ if (!e.target.closest(wrapper)) dropdown.hidden = true; });
  window.addEventListener('resize', ()=>{ if (!dropdown.hidden) showMatches(); });
})();

/* Init */
document.addEventListener('DOMContentLoaded', ()=>{
  // show/hide mobile select labels based on viewport
  if (window.matchMedia && window.matchMedia('(max-width:768px)').matches) {
    countryInput.style.display = 'none';
    document.getElementById('label-country').style.display = 'none';
    countrySelect.style.display = 'block';
    labelCountrySelect.style.display = 'block';
  } else {
    countrySelect.style.display = 'none';
    labelCountrySelect.style.display = 'none';
  }

  loadData();
});
</script>
</body>
</html>
